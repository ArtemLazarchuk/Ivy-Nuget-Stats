name: Update Remote Postgres

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update_nuget_stats:
    runs-on: ubuntu-latest
    steps:
      - name: Install DB driver
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary requests

      - name: Run Nuget Update
        env:
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          python - <<EOF
          import os
          import requests
          import psycopg2
          from datetime import date

          # Fetch Nuget Downloads
          try:
              downloads = requests.get("https://azuresearch-usnc.nuget.org/query?q=packageid:Ivy").json()['data'][0]['totalDownloads']
          except Exception as e:
              print(f"Error fetching Nuget stats: {e}")
              exit(1)

          date_to_record = date.today().isoformat()

          if downloads > 0:
              try:
                  conn = psycopg2.connect(os.getenv('DB_URL'))
                  cur = conn.cursor()
                  
                  # Nuget History Table
                  cur.execute("""
                      CREATE TABLE IF NOT EXISTS nuget_history (
                          id SERIAL PRIMARY KEY,
                          package_name TEXT,
                          downloads BIGINT,
                          date DATE DEFAULT CURRENT_DATE,
                          UNIQUE(package_name, date)
                      );
                  """)
                  cur.execute("""
                      INSERT INTO nuget_history (package_name, downloads, date)
                      VALUES (%s, %s, %s)
                      ON CONFLICT (package_name, date) 
                      DO UPDATE SET downloads = EXCLUDED.downloads;
                  """, ("Ivy", downloads, date_to_record))

                  conn.commit()
                  cur.close()
                  conn.close()
                  print(f"Success! Ivy: {downloads} downloads added/updated in database.")
              except Exception as e:
                  print(f"Database error: {e}")
                  exit(1)
          else:
              print("No downloads found or fetch returned 0.")
              exit(1)
          EOF

  update_github_stats:
    runs-on: ubuntu-latest
    steps:
      - name: Install DB driver
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary requests

      - name: Run GitHub Update
        env:
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          python - <<EOF
          import os
          import requests
          import psycopg2
          from datetime import date

          # Fetch GitHub Stars
          stars = 0
          try:
              headers = {'User-Agent': 'python-request-script'}
              repo_data = requests.get("https://api.github.com/repos/Ivy-Interactive/Ivy-Framework", headers=headers).json()
              stars = repo_data.get('stargazers_count', 0)
          except Exception as e:
              print(f"Error fetching GitHub stats: {e}")
              exit(1)

          date_to_record = date.today().isoformat()
          
          if stars > 0:
              try:
                  conn = psycopg2.connect(os.getenv('DB_URL'))
                  cur = conn.cursor()

                  # GitHub Stars Table
                  cur.execute("""
                      CREATE TABLE IF NOT EXISTS github_stars_history (
                          id SERIAL PRIMARY KEY,
                          repo_name TEXT,
                          stars BIGINT,
                          date DATE DEFAULT CURRENT_DATE,
                          UNIQUE(repo_name, date)
                      );
                  """)
                  
                  cur.execute("""
                      INSERT INTO github_stars_history (repo_name, stars, date)
                      VALUES (%s, %s, %s)
                      ON CONFLICT (repo_name, date) 
                      DO UPDATE SET stars = EXCLUDED.stars;
                  """, ("Ivy-Interactive/Ivy-Framework", stars, date_to_record))

                  conn.commit()
                  cur.close()
                  conn.close()
                  print(f"Success! Ivy-Interactive/Ivy-Framework: {stars} stars added/updated in database.")
              except Exception as e:
                  print(f"Database error: {e}")
                  exit(1)
          else:
              print("No stars found or fetch returned 0.")
              exit(1) # Fail if we can't get stars, usually we expect at least 1 for this repo
          EOF

  update_github_stargazers:
    runs-on: ubuntu-latest
    steps:
      - name: Install DB driver
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary requests

      - name: Run GitHub Stargazers Update
        env:
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          python - <<EOF
          import os
          import requests
          import psycopg2
          from datetime import date

          REPO = "Ivy-Interactive/Ivy-Framework"

          def fetch_all_stargazers():
              stargazers = []
              page = 1

              headers = {
                  "Accept": "application/vnd.github.star+json",
                  "User-Agent": "ivy-nuget-stats-stargazers-script"
              }

              while True:
                  url = f"https://api.github.com/repos/{REPO}/stargazers"
                  params = {"per_page": 100, "page": page}
                  resp = requests.get(url, headers=headers, params=params)

                  if resp.status_code != 200:
                      print(f"Error fetching stargazers (status {resp.status_code}): {resp.text}")
                      raise SystemExit(1)

                  data = resp.json()
                  if not data:
                      break

                  for item in data:
                      user = item.get("user", {})
                      login = user.get("login")
                      starred_at = item.get("starred_at")
                      if login:
                          stargazers.append((login, starred_at))

                  page += 1

              return stargazers

          try:
              stargazers = fetch_all_stargazers()
          except SystemExit:
              raise
          except Exception as e:
              print(f"Unexpected error fetching stargazers: {e}")
              raise SystemExit(1)

          print(f"Fetched {len(stargazers)} stargazers for {REPO}.")

          if not stargazers:
              print("No stargazers returned; nothing to update.")
              raise SystemExit(0)

          try:
              conn = psycopg2.connect(os.getenv("DB_URL"))
              cur = conn.cursor()

              # Table with one row per user who has ever starred the repo
              cur.execute("""
                  CREATE TABLE IF NOT EXISTS github_stargazers (
                      id SERIAL PRIMARY KEY,
                      repo_name TEXT,
                      user_login TEXT,
                      starred_at TIMESTAMPTZ,
                      first_seen DATE DEFAULT CURRENT_DATE,
                      UNIQUE(repo_name, user_login)
                  );
              """)

              insert_query = """
                  INSERT INTO github_stargazers (repo_name, user_login, starred_at)
                  VALUES (%s, %s, %s)
                  ON CONFLICT (repo_name, user_login) DO NOTHING;
              """

              new_count = 0
              for login, starred_at in stargazers:
                  cur.execute(insert_query, (REPO, login, starred_at))
                  if cur.rowcount > 0:
                      new_count += 1

              conn.commit()
              cur.close()
              conn.close()

              print(f"Stargazers update complete. New users inserted: {new_count}. Total processed: {len(stargazers)}.")
          except Exception as e:
              print(f"Database error while updating stargazers: {e}")
              raise SystemExit(1)
          EOF

