name: Update Remote Postgres

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update_nuget_stats:
    runs-on: ubuntu-latest
    steps:
      - name: Install DB driver
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary requests

      - name: Run Nuget Update
        env:
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          python - <<EOF
          import os
          import requests
          import psycopg2
          from datetime import date

          # Fetch Nuget Downloads
          try:
              downloads = requests.get("https://azuresearch-usnc.nuget.org/query?q=packageid:Ivy").json()['data'][0]['totalDownloads']
          except Exception as e:
              print(f"Error fetching Nuget stats: {e}")
              exit(1)

          date_to_record = date.today().isoformat()

          if downloads > 0:
              try:
                  conn = psycopg2.connect(os.getenv('DB_URL'))
                  cur = conn.cursor()
                  
                  # Nuget History Table
                  cur.execute("""
                      CREATE TABLE IF NOT EXISTS nuget_history (
                          id SERIAL PRIMARY KEY,
                          package_name TEXT,
                          downloads BIGINT,
                          date DATE DEFAULT CURRENT_DATE,
                          UNIQUE(package_name, date)
                      );
                  """)
                  cur.execute("""
                      INSERT INTO nuget_history (package_name, downloads, date)
                      VALUES (%s, %s, %s)
                      ON CONFLICT (package_name, date) 
                      DO UPDATE SET downloads = EXCLUDED.downloads;
                  """, ("Ivy", downloads, date_to_record))

                  conn.commit()
                  cur.close()
                  conn.close()
                  print(f"Success! Ivy: {downloads} downloads added/updated in database.")
              except Exception as e:
                  print(f"Database error: {e}")
                  exit(1)
          else:
              print("No downloads found or fetch returned 0.")
              exit(1)
          EOF

  update_github_stats:
    runs-on: ubuntu-latest
    steps:
      - name: Install DB driver
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary requests

      - name: Run GitHub Update
        env:
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          python - <<EOF
          import os
          import requests
          import psycopg2
          from datetime import date

          # Fetch GitHub Stars
          stars = 0
          try:
              headers = {'User-Agent': 'python-request-script'}
              repo_data = requests.get("https://api.github.com/repos/Ivy-Interactive/Ivy-Framework", headers=headers).json()
              stars = repo_data.get('stargazers_count', 0)
          except Exception as e:
              print(f"Error fetching GitHub stats: {e}")
              exit(1)

          date_to_record = date.today().isoformat()
          
          if stars > 0:
              try:
                  conn = psycopg2.connect(os.getenv('DB_URL'))
                  cur = conn.cursor()

                  # GitHub Stars Table
                  cur.execute("""
                      CREATE TABLE IF NOT EXISTS github_stars_history (
                          id SERIAL PRIMARY KEY,
                          repo_name TEXT,
                          stars BIGINT,
                          date DATE DEFAULT CURRENT_DATE,
                          UNIQUE(repo_name, date)
                      );
                  """)
                  
                  cur.execute("""
                      INSERT INTO github_stars_history (repo_name, stars, date)
                      VALUES (%s, %s, %s)
                      ON CONFLICT (repo_name, date) 
                      DO UPDATE SET stars = EXCLUDED.stars;
                  """, ("Ivy-Interactive/Ivy-Framework", stars, date_to_record))

                  conn.commit()
                  cur.close()
                  conn.close()
                  print(f"Success! Ivy-Interactive/Ivy-Framework: {stars} stars added/updated in database.")
              except Exception as e:
                  print(f"Database error: {e}")
                  exit(1)
          else:
              print("No stars found or fetch returned 0.")
              exit(1) # Fail if we can't get stars, usually we expect at least 1 for this repo
          EOF

  update_github_stargazers:
    runs-on: ubuntu-latest
    needs: update_github_stats
    steps:
      - name: Install DB driver
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary requests

      - name: Run GitHub Stargazers Update
        env:
          DB_URL: ${{ secrets.DB_URL }}
        run: |
          python - <<EOF
          import os
          import requests
          import psycopg2
          from datetime import date, datetime, timezone
          
          REPO = "Ivy-Interactive/Ivy-Framework"
          
          def fetch_all_stargazers():
              stargazers = []
              page = 1
          
              headers = {
                  "Accept": "application/vnd.github.star+json",
                  "User-Agent": "ivy-nuget-stats-stargazers-script"
              }
          
              while True:
                  url = f"https://api.github.com/repos/{REPO}/stargazers"
                  params = {"per_page": 100, "page": page}
                  resp = requests.get(url, headers=headers, params=params)
          
                  if resp.status_code != 200:
                      print(f"Error fetching stargazers (status {resp.status_code}): {resp.text}")
                      raise SystemExit(1)
          
                  data = resp.json()
                  if not data:
                      break
          
                  for item in data:
                      user = item.get("user", {})
                      login = user.get("login")
                      starred_at = item.get("starred_at")
                      if login:
                          stargazers.append((login, starred_at))
          
                  page += 1
          
              return stargazers
          
          try:
              stargazers = fetch_all_stargazers()
          except SystemExit:
              raise
          except Exception as e:
              print(f"Unexpected error fetching stargazers: {e}")
              raise SystemExit(1)
          
          print(f"Fetched {len(stargazers)} stargazers for {REPO}.")
          
          if not stargazers:
              print("No stargazers returned; nothing to update.")
              raise SystemExit(0)
          
          try:
              conn = psycopg2.connect(os.getenv("DB_URL"))
              cur = conn.cursor()
          
              # Setup tables
              cur.execute("""
                  CREATE TABLE IF NOT EXISTS github_stargazers (
                      id SERIAL PRIMARY KEY,
                      repo_name TEXT,
                      user_login TEXT,
                      starred_at TIMESTAMPTZ,
                      first_seen DATE DEFAULT CURRENT_DATE,
                      unstarred_at TIMESTAMPTZ,
                      star_duration_days NUMERIC,
                      UNIQUE(repo_name, user_login)
                  );
                  ALTER TABLE github_stargazers ADD COLUMN IF NOT EXISTS unstarred_at TIMESTAMPTZ;
                  ALTER TABLE github_stargazers ADD COLUMN IF NOT EXISTS star_duration_days NUMERIC;
                  
                  CREATE TABLE IF NOT EXISTS github_stargazers_daily (
                      id SERIAL PRIMARY KEY,
                      repo_name TEXT,
                      date DATE DEFAULT CURRENT_DATE,
                      new_count INTEGER DEFAULT 0,
                      unstar_count INTEGER DEFAULT 0,
                      reactivated_count INTEGER DEFAULT 0,
                      UNIQUE(repo_name, date)
                  );
              """)

              # Get previous state
              cur.execute("""
                  SELECT user_login FROM github_stargazers
                  WHERE repo_name = %s AND unstarred_at IS NULL;
              """, (REPO,))
              previously_active = {row[0] for row in cur.fetchall()}
              current_active = {login for login, _ in stargazers}
              joined_logins = sorted(current_active - previously_active)
              left_logins = sorted(previously_active - current_active)
          
              # Insert new stargazers
              new_count = 0
              for login, starred_at in stargazers:
                  cur.execute("""
                      INSERT INTO github_stargazers (repo_name, user_login, starred_at)
                      VALUES (%s, %s, %s) ON CONFLICT (repo_name, user_login) DO NOTHING;
                  """, (REPO, login, starred_at))
                  if cur.rowcount > 0:
                      new_count += 1

              # Reactivate users
              reactivate_count = 0
              reactivated_logins = []
              for login in current_active:
                  cur.execute("""
                      UPDATE github_stargazers SET unstarred_at = NULL
                      WHERE repo_name = %s AND user_login = %s AND unstarred_at IS NOT NULL;
                  """, (REPO, login))
                  if cur.rowcount > 0:
                      reactivate_count += 1
                      reactivated_logins.append(login)

              # Mark unstarred and calculate duration
              now_utc = datetime.now(timezone.utc)
              left_count = 0
              star_durations = {}
              
              for login in left_logins:
                  cur.execute("""
                      SELECT starred_at FROM github_stargazers
                      WHERE repo_name = %s AND user_login = %s AND unstarred_at IS NULL;
                  """, (REPO, login))
                  row = cur.fetchone()
                  
                  if row and row[0]:
                      try:
                          starred_at = row[0]
                          if starred_at.tzinfo is None:
                              starred_at = starred_at.replace(tzinfo=timezone.utc)
                          duration_days = (now_utc - starred_at).total_seconds() / 86400
                          if duration_days >= 0:
                              star_durations[login] = duration_days
                              cur.execute("""
                                  UPDATE github_stargazers
                                  SET unstarred_at = %s, star_duration_days = %s
                                  WHERE repo_name = %s AND user_login = %s AND unstarred_at IS NULL;
                              """, (now_utc, duration_days, REPO, login))
                          else:
                              cur.execute("""
                                  UPDATE github_stargazers SET unstarred_at = %s
                                  WHERE repo_name = %s AND user_login = %s AND unstarred_at IS NULL;
                              """, (now_utc, REPO, login))
                      except Exception:
                          cur.execute("""
                              UPDATE github_stargazers SET unstarred_at = %s
                              WHERE repo_name = %s AND user_login = %s AND unstarred_at IS NULL;
                          """, (now_utc, REPO, login))
                  else:
                      cur.execute("""
                          UPDATE github_stargazers SET unstarred_at = %s
                          WHERE repo_name = %s AND user_login = %s AND unstarred_at IS NULL;
                      """, (now_utc, REPO, login))
                  
                  if cur.rowcount > 0:
                      left_count += 1

              # Save daily aggregation
              date_to_record = date.today().isoformat()
              cur.execute("""
                  INSERT INTO github_stargazers_daily (repo_name, date, new_count, unstar_count, reactivated_count)
                  VALUES (%s, %s, %s, %s, %s)
                  ON CONFLICT (repo_name, date) DO UPDATE SET
                      new_count = github_stargazers_daily.new_count + EXCLUDED.new_count,
                      unstar_count = github_stargazers_daily.unstar_count + EXCLUDED.unstar_count,
                      reactivated_count = github_stargazers_daily.reactivated_count + EXCLUDED.reactivated_count;
              """, (REPO, date_to_record, new_count, left_count, reactivate_count))
          
              conn.commit()
              cur.close()
              conn.close()
          
              print(f"Stargazers update complete. New: {new_count}, Unstarred: {left_count}, Reactivated: {reactivate_count}. Total fetched: {len(stargazers)}.")
              print(f"Daily aggregation saved: date={date_to_record}, new={new_count}, unstar={left_count}, reactivated={reactivate_count}")

              if joined_logins:
                  print("New stargazers since last run:")
                  for login in joined_logins:
                      print(f"  + {login}")
              else:
                  print("No new stargazers since last run.")

              if left_logins:
                  print("Users who unstarred since last run:")
                  for login in left_logins:
                      duration = star_durations.get(login)
                      if duration is not None:
                          print(f"  - {login} (used for {int(round(duration))} days)")
                      else:
                          print(f"  - {login}")
              else:
                  print("No users unstarred since last run.")

              if reactivated_logins:
                  print("Users who re-starred since last run:")
                  for login in sorted(reactivated_logins):
                      print(f"  * {login}")
          except Exception as e:
              print(f"Database error while updating stargazers: {e}")
              raise SystemExit(1)
          EOF

